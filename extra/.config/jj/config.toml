#:schema https://docs.jj-vcs.dev/latest/config-schema.json

# [user] is defined in conf.d/user.toml (not managed by dotfiles)

[revsets]
log = "present(@) | (trunk()..@).. | (trunk()..@)- | (trunk()..@)--"

[aliases]
log-default = ["log", "-r", "present(@) | ancestors(immutable_heads().., 2) | present(trunk())"]
log-all = ["log", "-r", "all()"]
info = ["util", "exec", "--", "bash", "-c", """
set -euo pipefail
jj check
echo ""
echo "---------- log ----------"
echo ""
jj log --limit 15
echo ""
echo "---------- status ----------"
echo ""
jj st
"""]
bup = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]
bo = ["util", "exec", "--", "bash", "-c", """
set -euxo pipefail
jj bookmark create $@ -r @-
jj bookmark track $@ --remote=origin
""", ""]
check = ["util", "exec", "--", "bash", "-c", """
set -euo pipefail
echo '==> Running gitleaks...'
gitleaks detect --source . --no-git
echo '==> Running git-secrets...'
git-secrets --scan -r .
echo '==> All checks passed.'
"""]

[ui]
default-command = ["info"]
diff-formatter = ["difft", "--color=always", "$left", "$right"]
editor = "hx"

[template-aliases]
'my_log_oneline(commit)' = '''
if(commit.root(),
  format_root_commit(commit),
  label(
    separate(" ",
      if(commit.current_working_copy(), "working_copy"),
      if(commit.immutable(), "immutable", "mutable"),
      if(commit.conflict(), "conflicted"),
    ),
    separate(" ",
      format_short_change_id_with_change_offset(commit),
      commit.author().name(),
      commit.bookmarks(),
      commit.tags(),
      commit.working_copies(),
      format_short_commit_id(commit.commit_id()),
      format_commit_labels(commit),
      if(config("ui.show-cryptographic-signatures").as_boolean(),
        format_short_cryptographic_signature(commit.signature())
      ),
      if(commit.empty(), label("empty", "(empty)")),
      if(commit.description(),
        commit.description().first_line(),
        label(if(commit.empty(), "empty"), "(no description set)"),
      ),
    ) ++ "\n",
  )
)
'''

'my_op_log_oneline(op)' = '''
label(if(current_operation, "current_operation"),
  coalesce(
    if(op.root(), format_root_operation(op)),
    separate(" ",
      format_short_operation_id(op.id()),
      format_user_redacted(op.user()),
      op.time().end(),
      op.tags(),
      op.description().first_line(),
    ) ++ "\n",
  )
)
'''

[templates]
log = "my_log_oneline(self)"
op_log = "my_op_log_oneline(self)"
